From e158cd9ab14995e385585d856c6397a3782e3874 Mon Sep 17 00:00:00 2001
From: Samuel Macleod <smacleod@cloudflare.com>
Date: Fri, 20 Jan 2023 19:19:37 +0000
Subject: [PATCH 07/14] Support theme= url parameter for forcing the theme from
 outside

---
 .../ui/legacy/theme_support/ThemeSupport.ts      | 16 ++++++++++++----
 1 file changed, 12 insertions(+), 4 deletions(-)

diff --git a/front_end/ui/legacy/theme_support/ThemeSupport.ts b/front_end/ui/legacy/theme_support/ThemeSupport.ts
index 87d8a05a43..3e3bdbfee9 100644
--- a/front_end/ui/legacy/theme_support/ThemeSupport.ts
+++ b/front_end/ui/legacy/theme_support/ThemeSupport.ts
@@ -165,11 +165,16 @@ export class ThemeSupport extends EventTarget {
   }
 
   #applyThemeToDocument(document: Document): void {
+    const currentSetting = this.setting.get();
+    // Get theme from url, to allow for theme inheritance from the Cloudflare dashboard
+    const urlParams = new URLSearchParams(document.location.search);
+    const theme = urlParams.get('theme') ?? 'systemPreferred';
     const isForcedColorsMode = window.matchMedia('(forced-colors: active)').matches;
     const systemPreferredTheme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'default';
 
-    const useSystemPreferred = this.setting.get() === 'systemPreferred' || isForcedColorsMode;
-    this.themeNameInternal = useSystemPreferred ? systemPreferredTheme : this.setting.get();
+    const useSystemPreferred = theme === 'systemPreferred' || isForcedColorsMode;
+    this.themeNameInternal = useSystemPreferred ? systemPreferredTheme : theme;
+
     document.documentElement.classList.toggle('theme-with-dark-background', this.themeNameInternal === 'dark');
 
     const useChromeTheme = Common.Settings.moduleSetting('chrome-theme-colors').get();
@@ -189,9 +194,12 @@ export class ThemeSupport extends EventTarget {
       document.documentElement.classList.toggle('baseline-grayscale', true);
     }
 
+    this.setting.set(theme);
     // In the event the theme changes we need to clear caches and notify subscribers.
-    themeValueByTargetByName.clear();
-    this.dispatchEvent(new ThemeChangeEvent());
+    if (currentSetting !== theme) {
+      themeValueByTargetByName.clear();
+      this.dispatchEvent(new ThemeChangeEvent());
+    }
   }
 
   static clearThemeCache(): void {
-- 
2.39.5 (Apple Git-154)

